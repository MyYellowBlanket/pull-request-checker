package riki

import (
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"github.com/tengattack/unified-ci/checks/vulnerability/common"
)

func TestCheck(t *testing.T) {
	assert := assert.New(t)
	require := require.New(t)

	scanner := &Scanner{ProjectName: "test-java"}
	ok, err := scanner.CheckPackages(common.Java, "../testdata/pom.xml")
	require.NoError(err)
	assert.True(ok)

	scanner.WaitForQuery()
	ok, data, err := scanner.Query()
	require.NoError(err)
	assert.False(ok)
	assert.NotEmpty(data)
}

var sample = `|level|name|version|title|
|---|---|---|---|
|高|fastjson|1.2.49|Fastjson存在命令执行漏洞|
`

func TestMD(t *testing.T) {
	assert := assert.New(t)

	d := Data{
		VulRisk:  "高",
		Name:     "fastjson",
		Version:  "1.2.49",
		VulTitle: "Fastjson存在命令执行漏洞",
	}
	md := d.MDTitle() + d.ToMDTable()
	assert.Equal(sample, md)
}
